<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
    <title>Subscribers | Croevo AI</title>
</head>
<body>

<nav class="sidebar">
    <h3 class="gradient-text">CROEVO ADMIN</h3>
    <ul class="nav-menu">
        <li><a href="dashboard.html">Overview</a></li>
        <li><a href="memo-gen.html">Memo Generator</a></li>
        <li><a href="news-post.html">Announcements</a></li>
        <li><a href="team-manage.html">Team Control</a></li>
        <li><a href="subscribers.html" class="active">Subscribers</a></li>
        <li><a href="settings.html">Settings</a></li>
    </ul>
</nav>

<div class="main-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h2 class="gradient-text">ðŸ“§ Newsletter Subscribers</h2>
        <button id="exportBtn" class="btn-primary" style="padding: 8px 16px; font-size: 0.8rem;">Export to CSV</button>
    </div>
    
    <div class="admin-card">
        <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; color: #94a3b8; font-size: 0.9rem;">
            <span>Total Subscribers: <span id="subCount" style="color: var(--primary); font-weight: bold;">0</span></span>
            <span>Latest Sign-ups First</span>
        </div>

        <table style="width: 100%; border-collapse: collapse; text-align: left;">
            <thead>
                <tr style="border-bottom: 1px solid var(--glass-border); color: var(--primary);">
                    <th style="padding: 12px;">Email Address</th>
                    <th style="padding: 12px;">Date Joined</th>
                    <th style="padding: 12px; text-align: right;">Status</th>
                </tr>
            </thead>
            <tbody id="subscriberTableBody">
                <tr>
                    <td colspan="3" style="padding: 2rem; text-align: center; color: #64748b;">Fetching subscribers...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script type="module">
    import { supabase } from '../js/supabase-config.js';

    async function loadSubscribers() {
        const tableBody = document.getElementById('subscriberTableBody');
        const countSpan = document.getElementById('subCount');

        try {
            const { data: subs, error, count } = await supabase
                .from('subscribers')
                .select('*', { count: 'exact' })
                .order('created_at', { ascending: false });

            if (error) throw error;

            countSpan.innerText = count || 0;

            if (subs && subs.length > 0) {
                tableBody.innerHTML = subs.map(sub => `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <td style="padding: 15px;">${sub.email}</td>
                        <td style="padding: 15px; color: #94a3b8;">${new Date(sub.created_at).toLocaleDateString()}</td>
                        <td style="padding: 15px; text-align: right;">
                            <span style="color: #22c55e; background: rgba(34, 197, 94, 0.1); padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">Active</span>
                        </td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = `<tr><td colspan="3" style="padding: 2rem; text-align: center;">No subscribers yet.</td></tr>`;
            }
        } catch (err) {
            console.error("Fetch error:", err.message);
            tableBody.innerHTML = `<tr><td colspan="3" style="padding: 2rem; text-align: center; color: #ef4444;">Error loading data.</td></tr>`;
        }
    }

    // Export Functionality (Simple CSV)
    document.getElementById('exportBtn').onclick = () => {
        const rows = document.querySelectorAll('tr');
        let csvContent = "data:text/csv;charset=utf-8,Email,Date\n";
        
        // Skip header and map rows
        for(let i = 1; i < rows.length; i++) {
            const cols = rows[i].querySelectorAll('td');
            if(cols.length >= 2) {
                csvContent += `${cols[0].innerText},${cols[1].innerText}\n`;
            }
        }

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "croevo_subscribers.csv");
        document.body.appendChild(link);
        link.click();
    };

    loadSubscribers();
</script>

</body>
</html>